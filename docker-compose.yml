version: "3.8"

services:
  # Backend Service (Python/FastAPI)
  stable-diffusion:
    build: ./backend
    container_name: sdworks-backend
    ports:
      - "7860:7860"
    volumes:
      - huggingface-cache:/root/.cache/huggingface
      - ./models:/app/models
      - ./models:/app/models
      # Placeholders for custom model paths (Update these to your local paths)
      # - /path/to/your/Loras:/app/models/loras
      # - /path/to/your/Checkpoints:/app/models/legacy
    environment:
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

  # Frontend Service (Nginx)
  frontend:
    image: nginx:alpine
    container_name: sdworks-frontend
    ports:
      - "8080:80" # Access UI at localhost:8080
    volumes:
      # Mount the current directory (frontend source) to nginx root
      - .:/usr/share/nginx/html:ro
      # Mount custom nginx config from backend folder
      - ./backend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - stable-diffusion
    restart: unless-stopped

volumes:
  huggingface-cache:
